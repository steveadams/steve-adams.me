name: Deploy to Fastmail File Storage via WebDAV

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build VitePress site
        run: pnpm run build

      - name: Deploy to Fastmail via WebDAV
        run: |
          # Install davfs2 for WebDAV support
          sudo apt-get update
          sudo apt-get install -y davfs2

          # Create the mount point
          sudo mkdir -p /mnt/webdav

          # Mount WebDAV with better options for stability
          echo "${{ secrets.FASTMAIL_WEBDAV_PASSWORD }}" | sudo mount -t davfs ${{ secrets.FASTMAIL_WEBDAV_URL }} /mnt/webdav -o username=${{ secrets.FASTMAIL_WEBDAV_USERNAME }},uid=$(id -u),gid=$(id -g),file_mode=644,dir_mode=755

          # Ensure the target directory exists
          sudo mkdir -p "/mnt/webdav/steve-adams.me"

          # Deploy directly to the steve-adams.me directory
          echo "Deploying to steve-adams.me directory"
          sudo rsync -av --checksum --compress --delete ./.vitepress/dist/ "/mnt/webdav/steve-adams.me/"

          # Sync to ensure all writes are committed
          sudo sync
          sleep 1

          echo "Deployment completed successfully"

          # Unmount
          sudo umount /mnt/webdav
